name: è‡ªåŠ¨å‘å¸ƒ Release

on:
  push:
    tags:
      - 'v*'  # æ¨é€ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘

env:
  GO_VERSION: '1.24'
  PROJECT_NAME: 'xiaohu-jobs'

jobs:
  release:
    name: æ„å»ºå¹¶å‘å¸ƒ Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: read
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Go ç¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
        
    - name: å®‰è£…ä¾èµ–
      run: |
        go mod download
        go mod tidy
        
    - name: è¿è¡Œæµ‹è¯•
      run: go test -v ./...
      
    - name: æ„å»ºå¤šå¹³å°äºŒè¿›åˆ¶æ–‡ä»¶
      run: |
        echo "å¼€å§‹æ„å»ºå¤šå¹³å°äºŒè¿›åˆ¶æ–‡ä»¶..."
        
        # å®šä¹‰æ„å»ºå¹³å°
        PLATFORMS=(
          "linux/amd64"
          "linux/arm64"
          "windows/amd64"
          "darwin/amd64"
          "darwin/arm64"
        )
        
        # ä¸ºæ¯ä¸ªå¹³å°æ„å»º
        for platform in "${PLATFORMS[@]}"; do
          IFS='/' read -r os arch <<< "$platform"
          
          # è®¾ç½®æ–‡ä»¶æ‰©å±•å
          ext=""
          if [ "$os" = "windows" ]; then
            ext=".exe"
          fi
          
          # æ„å»ºæ–‡ä»¶å
          filename="${{ env.PROJECT_NAME }}-${os}-${arch}${ext}"
          
          echo "æ„å»º $filename..."
          GOOS=$os GOARCH=$arch \
          go build -v -ldflags="-s -w -X main.Version=${{ github.ref_name }}" \
          -o "$filename" main.go
          
          echo "âœ… $filename æ„å»ºå®Œæˆ ($(du -h "$filename" | cut -f1))"
        done
        
        echo "æ‰€æœ‰å¹³å°æ„å»ºå®Œæˆï¼"
        echo "æ„å»ºçš„æ–‡ä»¶:"
        ls -lh ${{ env.PROJECT_NAME }}-*
        
    - name: ç”Ÿæˆ Swagger æ–‡æ¡£
      run: |
        echo "ç”Ÿæˆ API æ–‡æ¡£..."
        go install github.com/swaggo/swag/cmd/swag@latest
        swag init -g main.go -o docs
        echo "âœ… API æ–‡æ¡£ç”Ÿæˆå®Œæˆ"
        
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        echo "åˆ›å»ºå‘å¸ƒåŒ…..."
        VERSION="${{ github.ref_name }}"
        RELEASE_DIR="release-${VERSION}"
        mkdir -p ${RELEASE_DIR}
        
        # å¤åˆ¶æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶
        echo "å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶..."
        cp ${{ env.PROJECT_NAME }}-* ${RELEASE_DIR}/ || echo "è­¦å‘Š: æŸäº›äºŒè¿›åˆ¶æ–‡ä»¶å¯èƒ½ä¸å­˜åœ¨"
        
        # å¤åˆ¶æ–‡æ¡£
        echo "å¤åˆ¶æ–‡æ¡£..."
        cp -r docs ${RELEASE_DIR}/ || echo "è­¦å‘Š: docs ç›®å½•ä¸å­˜åœ¨"
        cp README.md ${RELEASE_DIR}/ || echo "è­¦å‘Š: README.md ä¸å­˜åœ¨"
        cp LICENSE ${RELEASE_DIR}/ || echo "è­¦å‘Š: LICENSE ä¸å­˜åœ¨"
        
        # æ˜¾ç¤ºå‘å¸ƒåŒ…å†…å®¹
        echo "å‘å¸ƒåŒ…å†…å®¹:"
        ls -la ${RELEASE_DIR}/
        echo ""
        echo "äºŒè¿›åˆ¶æ–‡ä»¶è¯¦æƒ…:"
        ls -lh ${RELEASE_DIR}/${{ env.PROJECT_NAME }}-* || echo "æ²¡æœ‰æ‰¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶"
        
        # åˆ›å»ºå‹ç¼©åŒ…
        echo "åˆ›å»ºå‹ç¼©åŒ…..."
        tar -czf ${RELEASE_DIR}.tar.gz ${RELEASE_DIR}/
        zip -r ${RELEASE_DIR}.zip ${RELEASE_DIR}/
        
        echo "âœ… å‘å¸ƒåŒ…åˆ›å»ºå®Œæˆ"
        echo "å‹ç¼©åŒ…å¤§å°:"
        ls -lh ${RELEASE_DIR}.*
        
        # éªŒè¯å‹ç¼©åŒ…å†…å®¹
        echo "éªŒè¯å‹ç¼©åŒ…å†…å®¹:"
        echo "tar.gz å†…å®¹:"
        tar -tzf ${RELEASE_DIR}.tar.gz | grep ${{ env.PROJECT_NAME }} || echo "æ²¡æœ‰æ‰¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶"
        echo ""
        echo "zip å†…å®¹:"
        unzip -l ${RELEASE_DIR}.zip | grep ${{ env.PROJECT_NAME }} || echo "æ²¡æœ‰æ‰¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶"
        
    - name: æ£€æŸ¥æƒé™
      run: |
        echo "æ£€æŸ¥ GitHub Actions æƒé™..."
        echo "GITHUB_TOKEN æ˜¯å¦å­˜åœ¨: ${{ secrets.GITHUB_TOKEN != '' }}"
        echo "å½“å‰ç”¨æˆ·: ${{ github.actor }}"
        echo "ä»“åº“: ${{ github.repository }}"
        echo "æ ‡ç­¾: ${{ github.ref_name }}"
        echo "äº‹ä»¶ç±»å‹: ${{ github.event_name }}"
        
    - name: åˆ›å»º GitHub Release
      id: gh-release
      uses: softprops/action-gh-release@v1
      continue-on-error: true
      timeout-minutes: 10
      with:
        files: |
          release-${{ github.ref_name }}.tar.gz
          release-${{ github.ref_name }}.zip
        body: |
          ## ğŸš€ ç‰ˆæœ¬ ${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½
          - **Linux/macOS**: ä¸‹è½½ `.tar.gz` æ–‡ä»¶
          - **Windows**: ä¸‹è½½ `.zip` æ–‡ä»¶
          
          ### ğŸ”§ å®‰è£…
          ```bash
          # Linux/macOS
          tar -xzf release-${{ github.ref_name }}.tar.gz
          cd release-${{ github.ref_name }}
          chmod +x xiaohu-jobs-*
          
          # é€‰æ‹©é€‚åˆæ‚¨ç³»ç»Ÿçš„äºŒè¿›åˆ¶æ–‡ä»¶:
          # Linux x86_64: ./xiaohu-jobs-linux-amd64
          # Linux ARM64:  ./xiaohu-jobs-linux-arm64
          # macOS Intel:  ./xiaohu-jobs-darwin-amd64
          # macOS Apple Silicon: ./xiaohu-jobs-darwin-arm64
          
          # Windows
          # è§£å‹ .zip æ–‡ä»¶åè¿è¡Œ xiaohu-jobs-windows-amd64.exe
          ```
          
          ### ğŸ—ï¸ æ„å»ºä¿¡æ¯
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤: ${{ github.sha }}
          - ç‰ˆæœ¬: ${{ github.ref_name }}
          
          ### ğŸ“š æ–‡æ¡£
          - [API æ–‡æ¡£](docs/)
          - [ä½¿ç”¨è¯´æ˜](README.md)
          
          ### ğŸ” æ”¯æŒå¹³å°
          - **Linux**: amd64, arm64
          - **Windows**: amd64
          - **macOS**: amd64 (Intel), arm64 (Apple Silicon)
          
          ### ğŸ“ åŒ…å«æ–‡ä»¶
          - `xiaohu-jobs-linux-amd64` - Linux x86_64
          - `xiaohu-jobs-linux-arm64` - Linux ARM64
          - `xiaohu-jobs-windows-amd64.exe` - Windows x86_64
          - `xiaohu-jobs-darwin-amd64` - macOS Intel
          - `xiaohu-jobs-darwin-arm64` - macOS Apple Silicon
          - `docs/` - API æ–‡æ¡£
          - `README.md` - ä½¿ç”¨è¯´æ˜
          - `LICENSE` - è®¸å¯è¯æ–‡ä»¶
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: æ£€æŸ¥ Release çŠ¶æ€
      if: always()
      run: |
        echo "Release åˆ›å»ºç»“æœ: ${{ steps.gh-release.outputs.result }}"
        echo "Release URL: ${{ steps.gh-release.outputs.url }}"
        echo "Release ID: ${{ steps.gh-release.outputs.id }}"
        
        if [ "${{ steps.gh-release.outputs.result }}" == "success" ]; then
          echo "âœ… GitHub Release åˆ›å»ºæˆåŠŸ"
          echo "Release URL: ${{ steps.gh-release.outputs.url }}"
        else
          echo "âŒ GitHub Release åˆ›å»ºå¤±è´¥"
          echo "è¯·æ£€æŸ¥æƒé™è®¾ç½®æˆ–æ‰‹åŠ¨åˆ›å»º Release"
        fi
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: release-files-${{ github.ref_name }}
        path: |
          release-${{ github.ref_name }}.tar.gz
          release-${{ github.ref_name }}.zip
        retention-days: 30 