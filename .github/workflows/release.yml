name: è‡ªåŠ¨å‘å¸ƒ Release

on:
  push:
    tags:
      - 'v*'  # æ¨é€ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘

env:
  GO_VERSION: '1.24'
  PROJECT_NAME: 'xiaohu-jobs'

jobs:
  release:
    name: æ„å»ºå¹¶å‘å¸ƒ Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: read
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Go ç¯å¢ƒ
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
        
    - name: å®‰è£…ä¾èµ–
      run: |
        go mod download
        go mod tidy
        
    - name: è¿è¡Œæµ‹è¯•
      run: go test -v ./...
      
    - name: æ„å»ºå¤šå¹³å°äºŒè¿›åˆ¶æ–‡ä»¶
      run: |
        echo "å¼€å§‹æ„å»ºå¤šå¹³å°äºŒè¿›åˆ¶æ–‡ä»¶..."
        
        # å®šä¹‰æ„å»ºå¹³å°
        PLATFORMS=(
          "linux/amd64"
          "linux/arm64"
          "windows/amd64"
          "darwin/amd64"
          "darwin/arm64"
        )
        
        # ä¸ºæ¯ä¸ªå¹³å°æ„å»º
        for platform in "${PLATFORMS[@]}"; do
          IFS='/' read -r os arch <<< "$platform"
          
          # è®¾ç½®æ–‡ä»¶æ‰©å±•å
          ext=""
          if [ "$os" = "windows" ]; then
            ext=".exe"
          fi
          
          # æ„å»ºæ–‡ä»¶å
          filename="${{ env.PROJECT_NAME }}-${os}-${arch}${ext}"
          
          echo "æ„å»º $filename..."
          GOOS=$os GOARCH=$arch \
          go build -v -ldflags="-s -w -X main.Version=${{ github.ref_name }}" \
          -o "$filename" main.go
          
          echo "âœ… $filename æ„å»ºå®Œæˆ ($(du -h "$filename" | cut -f1))"
        done
        
        echo "æ‰€æœ‰å¹³å°æ„å»ºå®Œæˆï¼"
        echo "æ„å»ºçš„æ–‡ä»¶:"
        ls -lh ${{ env.PROJECT_NAME }}-*
        
    - name: ç”Ÿæˆ Swagger æ–‡æ¡£
      run: |
        echo "ç”Ÿæˆ API æ–‡æ¡£..."
        go install github.com/swaggo/swag/cmd/swag@latest
        swag init -g main.go -o docs
        echo "âœ… API æ–‡æ¡£ç”Ÿæˆå®Œæˆ"
        
    - name: åˆ›å»º Release
      id: create_release
      uses: actions/create-release@v1.1.4
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref_name }}
        body: |
          ## ğŸš€ å°èƒ¡å®šæ—¶ä»»åŠ¡ç³»ç»Ÿ ${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š
          
          - **Linux x86_64**: `xiaohu-jobs-linux-amd64`
          - **Linux ARM64**: `xiaohu-jobs-linux-arm64`
          - **Windows x64**: `xiaohu-jobs-windows-amd64.exe`
          - **macOS Intel**: `xiaohu-jobs-darwin-amd64`
          - **macOS Apple Silicon**: `xiaohu-jobs-darwin-arm64`
          
          ### ğŸ”§ ä½¿ç”¨è¯´æ˜
          1. ä¸‹è½½å¯¹åº”æ‚¨ç³»ç»Ÿçš„äºŒè¿›åˆ¶æ–‡ä»¶
          2. ç»™æ–‡ä»¶æ·»åŠ æ‰§è¡Œæƒé™ï¼ˆLinux/macOSï¼‰ï¼š`chmod +x xiaohu-jobs-*`
          3. è¿è¡Œç¨‹åºï¼š`./xiaohu-jobs-* start`
          
          ### ğŸ“‹ æ”¯æŒå¹³å°
          - **Linux**: amd64, arm64
          - **Windows**: amd64
          - **macOS**: amd64 (Intel), arm64 (Apple Silicon)
          
          ### ğŸ“„ åŒ…å«æ–‡ä»¶
          - å„å¹³å°äºŒè¿›åˆ¶æ–‡ä»¶
          - API æ–‡æ¡£ (`docs/`)
          
          ### ğŸ” æ›´æ–°æ—¥å¿—
          æŸ¥çœ‹ [GitHub æäº¤è®°å½•](https://github.com/${{ github.repository }}/commits/${{ github.ref }}) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
        draft: false
        prerelease: false
        
    - name: ä¸Šä¼  Linux amd64 äºŒè¿›åˆ¶æ–‡ä»¶
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./xiaohu-jobs-linux-amd64
        asset_name: xiaohu-jobs-linux-amd64
        asset_content_type: application/octet-stream
        
    - name: ä¸Šä¼  Linux arm64 äºŒè¿›åˆ¶æ–‡ä»¶
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./xiaohu-jobs-linux-arm64
        asset_name: xiaohu-jobs-linux-arm64
        asset_content_type: application/octet-stream
        
    - name: ä¸Šä¼  Windows amd64 äºŒè¿›åˆ¶æ–‡ä»¶
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./xiaohu-jobs-windows-amd64.exe
        asset_name: xiaohu-jobs-windows-amd64.exe
        asset_content_type: application/octet-stream
        
    - name: ä¸Šä¼  macOS Intel äºŒè¿›åˆ¶æ–‡ä»¶
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./xiaohu-jobs-darwin-amd64
        asset_name: xiaohu-jobs-darwin-amd64
        asset_content_type: application/octet-stream
        
    - name: ä¸Šä¼  macOS Apple Silicon äºŒè¿›åˆ¶æ–‡ä»¶
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./xiaohu-jobs-darwin-arm64
        asset_name: xiaohu-jobs-darwin-arm64
        asset_content_type: application/octet-stream

        
    - name: æ£€æŸ¥ Release çŠ¶æ€
      if: always()
      run: |
        echo "Release åˆ›å»ºç»“æœ: ${{ steps.create_release.outputs.result }}"
        echo "Release URL: ${{ steps.create_release.outputs.url }}"
        echo "Release ID: ${{ steps.create_release.outputs.id }}"
        
        if [ "${{ steps.create_release.outputs.result }}" == "success" ]; then
          echo "âœ… GitHub Release åˆ›å»ºæˆåŠŸ"
          echo "Release URL: ${{ steps.create_release.outputs.url }}"
        else
          echo "âŒ GitHub Release åˆ›å»ºå¤±è´¥"
          echo "è¯·æ£€æŸ¥æƒé™è®¾ç½®æˆ–æ‰‹åŠ¨åˆ›å»º Release"
        fi
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: release-binaries-${{ github.ref_name }}
        path: |
          xiaohu-jobs-*
        retention-days: 30 git