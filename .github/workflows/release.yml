name: è‡ªåŠ¨å‘å¸ƒ Release

on:
  push:
    tags:
      - 'v*'  # æ¨é€ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘

env:
  GO_VERSION: '1.24'
  PROJECT_NAME: 'xiaohu-jobs'

jobs:
  release:
    name: æ„å»ºå¹¶å‘å¸ƒ Release
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform:
          - name: linux-amd64
            os: linux
            arch: amd64
            ext: ''
          - name: linux-arm64
            os: linux
            arch: arm64
            ext: ''
          - name: windows-amd64
            os: windows
            arch: amd64
            ext: '.exe'
          - name: darwin-amd64
            os: darwin
            arch: amd64
            ext: ''
          - name: darwin-arm64
            os: darwin
            arch: arm64
            ext: ''
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Go ç¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
        
    - name: å®‰è£…ä¾èµ–
      run: |
        go mod download
        go mod tidy
        
    - name: è¿è¡Œæµ‹è¯•
      run: go test -v ./...
      
    - name: æ„å»ºå¤šå¹³å°äºŒè¿›åˆ¶æ–‡ä»¶
      run: |
        echo "æ„å»º ${{ matrix.platform.name }}..."
        GOOS=${{ matrix.platform.os }} GOARCH=${{ matrix.platform.arch }} \
        go build -v -ldflags="-s -w -X main.Version=${{ github.ref_name }}" \
        -o ${{ env.PROJECT_NAME }}-${{ matrix.platform.name }}${{ matrix.platform.ext }} main.go
        echo "âœ… ${{ matrix.platform.name }} æ„å»ºå®Œæˆ"
        
    - name: ç”Ÿæˆ Swagger æ–‡æ¡£
      run: |
        echo "ç”Ÿæˆ API æ–‡æ¡£..."
        go install github.com/swaggo/swag/cmd/swag@latest
        swag init -g main.go -o docs
        echo "âœ… API æ–‡æ¡£ç”Ÿæˆå®Œæˆ"
        
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        echo "åˆ›å»ºå‘å¸ƒåŒ…..."
        VERSION="${{ github.ref_name }}"
        RELEASE_DIR="release-${VERSION}"
        mkdir -p ${RELEASE_DIR}
        
        # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
        cp ${{ env.PROJECT_NAME }}-* ${RELEASE_DIR}/
        
        # å¤åˆ¶æ–‡æ¡£
        cp -r docs ${RELEASE_DIR}/
        cp README.md ${RELEASE_DIR}/ || echo "README.md ä¸å­˜åœ¨"
        cp LICENSE ${RELEASE_DIR}/ || echo "LICENSE ä¸å­˜åœ¨"
        
        # åˆ›å»ºå‹ç¼©åŒ…
        tar -czf ${RELEASE_DIR}.tar.gz ${RELEASE_DIR}/
        zip -r ${RELEASE_DIR}.zip ${RELEASE_DIR}/
        
        echo "âœ… å‘å¸ƒåŒ…åˆ›å»ºå®Œæˆ"
        
    - name: åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release-${{ github.ref_name }}.tar.gz
          release-${{ github.ref_name }}.zip
        body: |
          ## ğŸš€ ç‰ˆæœ¬ ${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½
          - **Linux/macOS**: ä¸‹è½½ `.tar.gz` æ–‡ä»¶
          - **Windows**: ä¸‹è½½ `.zip` æ–‡ä»¶
          
          ### ğŸ”§ å®‰è£…
          ```bash
          # Linux/macOS
          tar -xzf release-${{ github.ref_name }}.tar.gz
          cd release-${{ github.ref_name }}
          chmod +x xiaohu-jobs-*
          ./xiaohu-jobs-linux-amd64  # æˆ–å¯¹åº”çš„æ¶æ„
          
          # Windows
          # è§£å‹ .zip æ–‡ä»¶åè¿è¡Œ .exe æ–‡ä»¶
          ```
          
          ### ğŸ—ï¸ æ„å»ºä¿¡æ¯
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤: ${{ github.sha }}
          - ç‰ˆæœ¬: ${{ github.ref_name }}
          
          ### ğŸ“š æ–‡æ¡£
          - [API æ–‡æ¡£](docs/)
          - [ä½¿ç”¨è¯´æ˜](README.md)
          
          ### ğŸ” æ”¯æŒå¹³å°
          - Linux (amd64, arm64)
          - Windows (amd64)
          - macOS (amd64, arm64)
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 