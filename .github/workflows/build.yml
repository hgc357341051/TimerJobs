name: å°èƒ¡ä»»åŠ¡ç³»ç»Ÿ CI/CD

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

env:
  GO_VERSION: '1.24'
  PROJECT_NAME: 'xiaohu-jobs'

jobs:
  # æ„å»ºå’Œæµ‹è¯•ä»»åŠ¡
  build-and-test:
    name: æ„å»ºå’Œæµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Go ç¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
        
    - name: å®‰è£…ä¾èµ–
      run: |
        go mod download
        go mod tidy
        
    - name: ä»£ç æ ¼å¼æ£€æŸ¥
      run: |
        echo "æ£€æŸ¥ä»£ç æ ¼å¼..."
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "âŒ ä»£ç æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·è¿è¡Œ 'gofmt -s -w .'"
          gofmt -s -l .
          exit 1
        fi
        echo "âœ… ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"
        
    - name: å¯¼å…¥æ ¼å¼æ£€æŸ¥
      run: |
        echo "æ£€æŸ¥å¯¼å…¥æ ¼å¼..."
        go install golang.org/x/tools/cmd/goimports@latest
        if [ "$(goimports -l . | wc -l)" -gt 0 ]; then
          echo "âŒ å¯¼å…¥æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·è¿è¡Œ 'goimports -w .'"
          goimports -l .
          exit 1
        fi
        echo "âœ… å¯¼å…¥æ ¼å¼æ£€æŸ¥é€šè¿‡"
        
    - name: è¿è¡Œæµ‹è¯•
      run: |
        echo "è¿è¡Œå•å…ƒæµ‹è¯•..."
        go test -v -race -coverprofile=coverage.out ./...
        echo "âœ… æµ‹è¯•å®Œæˆ"
        
    - name: ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
      run: |
        go tool cover -func=coverage.out
        go tool cover -html=coverage.out -o coverage.html
        
    - name: ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage.html
        
    - name: æ„å»ºé¡¹ç›®
      run: |
        echo "æ„å»ºé¡¹ç›®..."
        go build -v -ldflags="-s -w" -o ${{ env.PROJECT_NAME }} main.go
        echo "âœ… æ„å»ºå®Œæˆ"
        
    - name: ç”Ÿæˆ Swagger æ–‡æ¡£
      run: |
        echo "ç”Ÿæˆ API æ–‡æ¡£..."
        go install github.com/swaggo/swag/cmd/swag@latest
        swag init -g main.go -o docs
        echo "âœ… API æ–‡æ¡£ç”Ÿæˆå®Œæˆ"
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          ${{ env.PROJECT_NAME }}
          docs/

  # ä»£ç è´¨é‡æ£€æŸ¥ä»»åŠ¡
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Go ç¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: è¿è¡Œ golangci-lint
      uses: golangci/golangci-lint-action@v4
      with:
        version: latest
        args: --timeout=5m
        
    - name: å®‰å…¨æ¼æ´æ‰«æ
      run: |
        echo "æ‰«æå®‰å…¨æ¼æ´..."
        go install golang.org/x/vuln/cmd/govulncheck@latest
        govulncheck ./... || echo "âš ï¸ å‘ç°å®‰å…¨æ¼æ´ï¼Œè¯·æ£€æŸ¥å¹¶ä¿®å¤"
        echo "âœ… å®‰å…¨æ‰«æå®Œæˆ"

  # å¤šå¹³å°æ„å»ºä»»åŠ¡
  multi-platform-build:
    name: å¤šå¹³å°æ„å»º
    runs-on: ubuntu-latest
    needs: build-and-test
    
    strategy:
      matrix:
        platform:
          - name: linux-amd64
            os: linux
            arch: amd64
            ext: ''
          - name: windows-amd64
            os: windows
            arch: amd64
            ext: '.exe'
          - name: darwin-amd64
            os: darwin
            arch: amd64
            ext: ''
            
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Go ç¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: å®‰è£…ä¾èµ–
      run: go mod download
      
    - name: æ„å»º ${{ matrix.platform.name }}
      run: |
        echo "æ„å»º ${{ matrix.platform.name }}..."
        GOOS=${{ matrix.platform.os }} GOARCH=${{ matrix.platform.arch }} \
        go build -v -ldflags="-s -w" \
        -o ${{ env.PROJECT_NAME }}-${{ matrix.platform.name }}${{ matrix.platform.ext }} main.go
        echo "âœ… ${{ matrix.platform.name }} æ„å»ºå®Œæˆ"
        
    - name: ä¸Šä¼  ${{ matrix.platform.name }} æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.platform.name }}-binary
        path: ${{ env.PROJECT_NAME }}-${{ matrix.platform.name }}${{ matrix.platform.ext }}

  # é€šçŸ¥ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰
  notify:
    name: é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality, multi-platform-build]
    if: always()
    
    steps:
    - name: æ„å»ºçŠ¶æ€é€šçŸ¥
      run: |
        if [ "${{ needs.build-and-test.result }}" == "success" ] && \
           [ "${{ needs.code-quality.result }}" == "success" ] && \
           [ "${{ needs.multi-platform-build.result }}" == "success" ]; then
          echo "ğŸ‰ æ‰€æœ‰ä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼"
          echo "âœ… æ„å»ºå’Œæµ‹è¯•é€šè¿‡"
          echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡"
          echo "âœ… å¤šå¹³å°æ„å»ºå®Œæˆ"
        else
          echo "âŒ éƒ¨åˆ†ä»»åŠ¡æ‰§è¡Œå¤±è´¥"
          echo "æ„å»ºå’Œæµ‹è¯•: ${{ needs.build-and-test.result }}"
          echo "ä»£ç è´¨é‡æ£€æŸ¥: ${{ needs.code-quality.result }}"
          echo "å¤šå¹³å°æ„å»º: ${{ needs.multi-platform-build.result }}"
          exit 1
        fi 