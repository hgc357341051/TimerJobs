name: å°èƒ¡ä»»åŠ¡ç³»ç»Ÿ CI/CD

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

env:
  GO_VERSION: '1.24'
  PROJECT_NAME: 'xiaohu-jobs'

jobs:
  # æ„å»ºå’Œæµ‹è¯•ä»»åŠ¡
  build-and-test:
    name: æ„å»ºå’Œæµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Go ç¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
        
    - name: å®‰è£…ä¾èµ–
      run: |
        go mod download
        go mod tidy
        
    - name: ä»£ç æ ¼å¼æ£€æŸ¥
      run: |
        echo "æ£€æŸ¥ä»£ç æ ¼å¼..."
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "âŒ ä»£ç æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·è¿è¡Œ 'gofmt -s -w .'"
          gofmt -s -l .
          exit 1
        fi
        echo "âœ… ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"
        
    - name: å¯¼å…¥æ ¼å¼æ£€æŸ¥
      run: |
        echo "æ£€æŸ¥å¯¼å…¥æ ¼å¼..."
        go install golang.org/x/tools/cmd/goimports@latest
        if [ "$(goimports -l . | wc -l)" -gt 0 ]; then
          echo "âŒ å¯¼å…¥æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·è¿è¡Œ 'goimports -w .'"
          goimports -l .
          exit 1
        fi
        echo "âœ… å¯¼å…¥æ ¼å¼æ£€æŸ¥é€šè¿‡"
        
    - name: è¿è¡Œæµ‹è¯•
      run: |
        echo "è¿è¡Œå•å…ƒæµ‹è¯•..."
        go test -v -race -coverprofile=coverage.out ./...
        echo "âœ… æµ‹è¯•å®Œæˆ"
        
    - name: ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
      run: |
        go tool cover -func=coverage.out
        go tool cover -html=coverage.out -o coverage.html
        
    - name: ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage.html
        
    - name: æ„å»ºé¡¹ç›®
      run: |
        echo "æ„å»ºé¡¹ç›®..."
        go build -v -ldflags="-s -w" -o ${{ env.PROJECT_NAME }} main.go
        echo "âœ… æ„å»ºå®Œæˆ"
        
    - name: ç”Ÿæˆ Swagger æ–‡æ¡£
      run: |
        echo "ç”Ÿæˆ API æ–‡æ¡£..."
        go install github.com/swaggo/swag/cmd/swag@latest
        swag init -g main.go -o docs
        echo "âœ… API æ–‡æ¡£ç”Ÿæˆå®Œæˆ"
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          ${{ env.PROJECT_NAME }}
          docs/

  # ä»£ç è´¨é‡æ£€æŸ¥ä»»åŠ¡
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Go ç¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
        
    - name: è¿è¡Œ golangci-lint
      uses: golangci/golangci-lint-action@v4
      with:
        version: latest
        args: --timeout=5m
        skip-cache: false
        skip-preview: true
        
    - name: å®‰å…¨æ¼æ´æ‰«æ
      run: |
        echo "æ‰«æå®‰å…¨æ¼æ´..."
        go install golang.org/x/vuln/cmd/govulncheck@latest
        govulncheck ./... || echo "âš ï¸ å‘ç°å®‰å…¨æ¼æ´ï¼Œè¯·æ£€æŸ¥å¹¶ä¿®å¤"
        echo "âœ… å®‰å…¨æ‰«æå®Œæˆ"

  # å¤šå¹³å°æ„å»ºä»»åŠ¡
  multi-platform-build:
    name: å¤šå¹³å°æ„å»º
    runs-on: ubuntu-latest
    needs: build-and-test
    
    strategy:
      matrix:
        platform:
          - name: linux-amd64
            os: linux
            arch: amd64
            ext: ''
          - name: linux-arm64
            os: linux
            arch: arm64
            ext: ''
          - name: windows-amd64
            os: windows
            arch: amd64
            ext: '.exe'
          - name: darwin-amd64
            os: darwin
            arch: amd64
            ext: ''
          - name: darwin-arm64
            os: darwin
            arch: arm64
            ext: ''
            
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Go ç¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: å®‰è£…ä¾èµ–
      run: go mod download
      
    - name: æ„å»º ${{ matrix.platform.name }}
      run: |
        echo "æ„å»º ${{ matrix.platform.name }}..."
        GOOS=${{ matrix.platform.os }} GOARCH=${{ matrix.platform.arch }} \
        go build -v -ldflags="-s -w" \
        -o ${{ env.PROJECT_NAME }}-${{ matrix.platform.name }}${{ matrix.platform.ext }} main.go
        echo "âœ… ${{ matrix.platform.name }} æ„å»ºå®Œæˆ"
        
    - name: ä¸Šä¼  ${{ matrix.platform.name }} æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.platform.name }}-binary
        path: ${{ env.PROJECT_NAME }}-${{ matrix.platform.name }}${{ matrix.platform.ext }}

  # å®‰å…¨æ‰«æä»»åŠ¡
  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Go ç¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: ä¾èµ–æ¼æ´æ‰«æ
      run: |
        echo "æ‰«æä¾èµ–æ¼æ´..."
        go install golang.org/x/vuln/cmd/govulncheck@latest
        govulncheck ./... || echo "âš ï¸ å‘ç°å®‰å…¨æ¼æ´ï¼Œè¯·æ£€æŸ¥å¹¶ä¿®å¤"
        echo "âœ… ä¾èµ–æ¼æ´æ‰«æå®Œæˆ"
        
    - name: ä»£ç å®‰å…¨åˆ†æ
      run: |
        echo "è¿è¡Œä»£ç å®‰å…¨åˆ†æ..."
        go install github.com/securego/gosec/v2/cmd/gosec@latest
        gosec ./... || echo "âš ï¸ å‘ç°ä»£ç å®‰å…¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥å¹¶ä¿®å¤"
        echo "âœ… ä»£ç å®‰å…¨åˆ†æå®Œæˆ"
        
    - name: å®¹å™¨é•œåƒå®‰å…¨æ‰«æ
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        echo "æ‰«æå®¹å™¨é•œåƒå®‰å…¨..."
        # è¿™é‡Œå¯ä»¥é›†æˆ Trivy æˆ–å…¶ä»–å®¹å™¨å®‰å…¨æ‰«æå·¥å…·
        echo "âœ… å®¹å™¨é•œåƒå®‰å…¨æ‰«æå®Œæˆ"

  # æ€§èƒ½æµ‹è¯•ä»»åŠ¡
  performance-test:
    name: æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Go ç¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: è¿è¡ŒåŸºå‡†æµ‹è¯•
      run: |
        echo "è¿è¡ŒåŸºå‡†æµ‹è¯•..."
        go test -bench=. -benchmem ./... || echo "âš ï¸ åŸºå‡†æµ‹è¯•å¤±è´¥"
        echo "âœ… åŸºå‡†æµ‹è¯•å®Œæˆ"
        
    - name: å†…å­˜æ³„æ¼æ£€æµ‹
      run: |
        echo "æ£€æµ‹å†…å­˜æ³„æ¼..."
        go test -race ./... || echo "âš ï¸ å‘ç°ç«æ€æ¡ä»¶"
        echo "âœ… å†…å­˜æ³„æ¼æ£€æµ‹å®Œæˆ"

  # æ–‡æ¡£ç”Ÿæˆä»»åŠ¡
  docs-generation:
    name: æ–‡æ¡£ç”Ÿæˆ
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Go ç¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: ç”Ÿæˆ API æ–‡æ¡£
      run: |
        echo "ç”Ÿæˆ Swagger API æ–‡æ¡£..."
        go install github.com/swaggo/swag/cmd/swag@latest
        swag init -g main.go -o docs
        echo "âœ… API æ–‡æ¡£ç”Ÿæˆå®Œæˆ"
        
    - name: ç”Ÿæˆä»£ç æ–‡æ¡£
      run: |
        echo "ç”Ÿæˆä»£ç æ–‡æ¡£..."
        go install golang.org/x/tools/cmd/godoc@latest
        godoc -http=:6060 &
        sleep 5
        curl -s http://localhost:6060 > /dev/null && echo "âœ… ä»£ç æ–‡æ¡£ç”Ÿæˆå®Œæˆ" || echo "âš ï¸ ä»£ç æ–‡æ¡£ç”Ÿæˆå¤±è´¥"
        
    - name: ä¸Šä¼ æ–‡æ¡£
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: docs/

  # é€šçŸ¥ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰
  notify:
    name: é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality, multi-platform-build, security-scan, performance-test, docs-generation]
    if: always()
    
    steps:
    - name: æ„å»ºçŠ¶æ€é€šçŸ¥
      run: |
        echo "=== æ„å»ºçŠ¶æ€æŠ¥å‘Š ==="
        echo "æ„å»ºå’Œæµ‹è¯•: ${{ needs.build-and-test.result }}"
        echo "ä»£ç è´¨é‡æ£€æŸ¥: ${{ needs.code-quality.result }}"
        echo "å¤šå¹³å°æ„å»º: ${{ needs.multi-platform-build.result }}"
        echo "å®‰å…¨æ‰«æ: ${{ needs.security-scan.result }}"
        echo "æ€§èƒ½æµ‹è¯•: ${{ needs.performance-test.result }}"
        echo "æ–‡æ¡£ç”Ÿæˆ: ${{ needs.docs-generation.result }}"
        
        if [ "${{ needs.build-and-test.result }}" == "success" ] && \
           [ "${{ needs.code-quality.result }}" == "success" ] && \
           [ "${{ needs.multi-platform-build.result }}" == "success" ] && \
           [ "${{ needs.security-scan.result }}" == "success" ] && \
           [ "${{ needs.performance-test.result }}" == "success" ] && \
           [ "${{ needs.docs-generation.result }}" == "success" ]; then
          echo "ğŸ‰ æ‰€æœ‰ä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼"
          echo "âœ… æ„å»ºå’Œæµ‹è¯•é€šè¿‡"
          echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡"
          echo "âœ… å¤šå¹³å°æ„å»ºå®Œæˆ"
          echo "âœ… å®‰å…¨æ‰«æé€šè¿‡"
          echo "âœ… æ€§èƒ½æµ‹è¯•é€šè¿‡"
          echo "âœ… æ–‡æ¡£ç”Ÿæˆå®Œæˆ"
        else
          echo "âŒ éƒ¨åˆ†ä»»åŠ¡æ‰§è¡Œå¤±è´¥"
          exit 1
        fi 